<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Host ‚Äî Kerst Muziek Bingo</title>
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b0f13;color:#fff}
  #topbar{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#07101a}
  #title{font-size:18px}
  #controls{display:flex;gap:8px;align-items:center}
  button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  #startBtn{background:#27ae60;color:#000}
  #modeFrame{display:none;text-align:center;padding:18px}
  .modeBtn{padding:12px 20px;border-radius:10px;font-size:16px;margin:6px}
  #playArea{display:none;text-align:center;padding:16px}
  #playBtn{background:#e74c3c;color:#fff;padding:12px 18px;border-radius:10px;font-size:16px}
  #playersList{position:fixed;right:10px;top:72px;background:rgba(255,255,255,0.04);padding:10px;border-radius:8px;min-width:180px}
  #alerts{position:fixed;left:50%;transform:translateX(-50%);top:40%;display:none;background:#fff;color:#000;padding:20px;border-radius:12px;font-size:20px;z-index:999}
  #songLog{margin-top:12px;max-height:180px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .small{font-size:13px;color:#bbb}
  @media(max-width:520px){ #playersList{display:none} }
</style>
</head>
<body>
<div id="topbar">
  <div id="title">üéÑ Kerst Muziek Bingo ‚Äî Host</div>
  <div id="controls">
    <div id="time" class="small"></div>
    <button id="startBtn">Start</button>
  </div>
</div>

<div id="slides" style="text-align:center;padding:26px">
  <div id="slideInner" style="font-size:26px;opacity:1">Welkom bij Kerst Bingo! <br><img src="Pictures/JoinQR.png" alt="QR" style="max-width:180px;margin-top:10px"></div>
</div>

<div id="modeFrame">
  <div style="text-align:center;margin-top:6px">
    <button class="modeBtn" id="autoMode" style="background:#f39c12">ü§ñ Auto (30s play / 10s pauze)</button>
    <button class="modeBtn" id="hostMode" style="background:#3498db">üé§ Host (manueel)</button>
  </div>
  <div style="text-align:center;margin-top:12px" class="small">QR naar players: <span id="qrLink" style="word-break:break-word"></span></div>
</div>

<div id="playArea">
  <button id="playBtn">‚ñ∂Ô∏è SPEEL / STOP</button>
  <button id="skipBtn" style="margin-left:8px">‚è≠ Volgend Nummer</button>
  <div id="songLog" class="small"></div>
</div>

<div id="playersList"><strong>Players</strong><div id="players"></div></div>
<div id="alerts"></div>

<!-- audio -->
<audio id="audioPlayer" preload="auto"></audio>

<script>
/* ---------- JSONBin CONFIG (vul jouw waarden in) ----------
  - BIN_ID: je bin id (bijv. "xxxxxx")
  - MASTER_KEY: je master/private key (houd priv√©)
  - ENDPOINT: jsonbin endpoint zoals https://api.jsonbin.io/v3/b/<BIN_ID>
  Als je andere JSON-host gebruikt pas de URLs aan.
----------------------------------------------------------- */
var JSONBIN_BIN_ID = "69244907ae596e708f6d9ca4";
var JSONBIN_MASTER_KEY = "$2a$10$wgQZzbDjasLxt8TGqG52TOPxciwArMKp2mqWH5GEeNR9/wxTf4sn.";
var JSONBIN_ENDPOINT = "https://api.jsonbin.io/v3/b/" + JSONBIN_BIN_ID;

/* Basic song list: filenames in /Muziek/ met echte artiest/titels */
var songs = [
  {file:"Muziek/Mariah Carey - All I Want For Christmas Is You.mp3", title:"All I Want For Christmas Is You"},
  {file:"Muziek/Wham - Last Christmas.mp3", title:"Last Christmas"},
  {file:"Muziek/Sia - Snowman.mp3", title:"Snowman"}
  /* voeg hier je bestanden toe */
];

var used = [];
var playing = false;
var audio = document.getElementById('audioPlayer');
var playBtn = document.getElementById('playBtn');
var skipBtn = document.getElementById('skipBtn');
var songLog = document.getElementById('songLog');

/* clock */
setInterval(function(){ document.getElementById('time').innerText = new Date().toLocaleTimeString(); },1000);

/* slide simple */
var slideInner = document.getElementById('slideInner');
var slides = [
  "Welkom bij Kerst Bingo!",
  "<div>Scan om mee te doen:</div><img src='Pictures/JoinQR.png' style='max-width:200px;margin-top:8px'>",
  "Hoe werkt het spel?",
  "Dit wordt GE-WEL-DIG!"
];
var sIdx = 0;
function showSlide(){
  slideInner.style.opacity = 0;
  setTimeout(function(){
    slideInner.innerHTML = slides[sIdx];
    slideInner.style.opacity = 1;
    sIdx = (sIdx + 1) % slides.length;
  }, 350);
}
var slideTimer = setInterval(showSlide, 3000);

/* helper pick */
function pickSongIndex(){
  var remaining = [];
  for(var i=0;i<songs.length;i++){ if(used.indexOf(i) === -1) remaining.push(i); }
  if(remaining.length === 0) return null;
  var pick = remaining[Math.floor(Math.random()*remaining.length)];
  used.push(pick);
  return pick;
}
function logPlayed(t){
  var el = document.createElement('div'); el.innerText = (new Date()).toLocaleTimeString() + " ‚Äî " + t;
  songLog.insertBefore(el, songLog.firstChild);
}

/* send/update JSONBin helper */
function writeBin(json, cb){
  var url = JSONBIN_ENDPOINT;
  var req = new XMLHttpRequest();
  req.open("PUT", url, true);
  req.setRequestHeader("Content-Type","application/json");
  req.setRequestHeader("X-Master-Key", JSONBIN_MASTER_KEY);
  req.onreadystatechange = function(){
    if(req.readyState === 4){
      if(req.status >= 200 && req.status < 300){
        try{ cb && cb(JSON.parse(req.responseText)); } catch(e){ cb && cb(null); }
      } else { console.error("JSONBin PUT error", req.status, req.responseText); cb && cb(null); }
    }
  };
  req.send(JSON.stringify(json));
}
function readBin(cb){
  var url = JSONBIN_ENDPOINT + "/latest";
  var req = new XMLHttpRequest();
  req.open("GET", url, true);
  req.setRequestHeader("X-Master-Key", JSONBIN_MASTER_KEY); // some bins public read; if not, must include
  req.onreadystatechange = function(){
    if(req.readyState === 4){
      if(req.status >=200 && req.status < 300){
        try{ cb && cb(JSON.parse(req.responseText)); } catch(e){ cb && cb(null); }
      } else { console.error("JSONBin GET error", req.status, req.responseText); cb && cb(null); }
    }
  };
  req.send();
}

/* initialize minimal bin if empty */
function initBinIfNeeded(){
  readBin(function(data){
    if(!data || !data.record){
      var base = {
        currentSong: null,
        players: {},        /* object: nick -> { card:[], marked:[] } */
        events: []          /* array of events {type:'bingo', nick:'', ts:...} */
      };
      writeBin(base, function(){ console.log("Created base bin"); });
    }
  });
}

/* Start button behavior: hide slides, show modeFrame */
document.getElementById('startBtn').addEventListener('click', function(){
  clearInterval(slideTimer);
  slideInner.style.opacity = 0;
  setTimeout(function(){
    document.getElementById('slides').style.display = 'none';
    document.getElementById('modeFrame').style.display = 'block';
    // show quick QR link
    var link = (location.origin + location.pathname.replace(/[^\/]*$/,'') + "player.html").replace('//','/').replace(':/', '://');
    document.getElementById('qrLink').innerText = link + "  (scan met QR + stuur nickname)";
  }, 500);
});

/* play/skip manual */
playBtn.addEventListener('click', function(){
  if(playing){ audio.pause(); audio.currentTime = 0; playing=false; playBtn.innerText='‚ñ∂Ô∏è SPEEL / STOP'; return; }
  var idx = pickSongIndex(); if(idx === null){ alert("Alle nummers gespeeld"); return; }
  audio.src = songs[idx].file; audio.play(); playing=true; playBtn.innerText='‚èπ STOP';
  logPlayed(songs[idx].title);
  // update bin currentSong
  readBin(function(res){
    var record = (res && res.record) ? res.record : {currentSong:null, players:{}, events:[]};
    record.currentSong = {title: songs[idx].title, ts: Date.now()};
    writeBin(record);
  });
});
skipBtn.addEventListener('click', function(){
  audio.pause(); audio.currentTime = 0; playing=false; playBtn.innerText='‚ñ∂Ô∏è SPEEL / STOP';
  var idx = pickSongIndex(); if(idx === null){ alert("Alle nummers gespeeld"); return; }
  audio.src = songs[idx].file; audio.play(); playing=true; playBtn.innerText='‚èπ STOP';
  logPlayed(songs[idx].title);
  readBin(function(res){
    var record = (res && res.record) ? res.record : {currentSong:null, players:{}, events:[]};
    record.currentSong = {title: songs[idx].title, ts: Date.now()};
    writeBin(record);
  });
});

/* Auto mode (30s play / 10s pause) */
document.getElementById('autoMode').addEventListener('click', function(){
  document.getElementById('modeFrame').style.display='none';
  document.getElementById('playArea').style.display='block';
  (function autoLoop(){
    var idx = pickSongIndex(); if(idx === null){ alert("Alle nummers gespeeld"); return; }
    audio.src = songs[idx].file; audio.play(); playing=true; playBtn.innerText='‚èπ STOP';
    logPlayed(songs[idx].title);
    readBin(function(res){
      var record = (res && res.record) ? res.record : {currentSong:null, players:{}, events:[]};
      record.currentSong = {title: songs[idx].title, ts: Date.now()};
      writeBin(record);
    });
    setTimeout(function(){ audio.pause(); playing=false; playBtn.innerText='‚ñ∂Ô∏è SPEEL / STOP'; }, 30000);
    if(used.length < songs.length) setTimeout(autoLoop, 40000);
  })();
});
/* Host mode */
document.getElementById('hostMode').addEventListener('click', function(){
  document.getElementById('modeFrame').style.display='none';
  document.getElementById('playArea').style.display='block';
});

/* Poll players & events every 1.5s */
function poll(){
  readBin(function(res){
    if(!res || !res.record) return;
    var rec = res.record;
    // players list
    var pEl = document.getElementById('players');
    pEl.innerHTML = '';
    for(var k in rec.players){
      var d = document.createElement('div');
      d.innerText = k;
      pEl.appendChild(d);
    }
    // events
    if(rec.events && rec.events.length){
      // process new events (we'll pop handled ones client-side by remembering last ts)
      if(!window._lastEventTs) window._lastEventTs = 0;
      for(var i=0;i<rec.events.length;i++){
        var ev = rec.events[i];
        if(ev.ts > window._lastEventTs){
          window._lastEventTs = ev.ts;
          if(ev.type === 'bingo'){
            showAlert("üéâ BINGO: " + (ev.nick || ''));
            // (optional) play sound by writing a small 'action' into bin (players can react), but for now host just shows
          } else if(ev.type === 'falseBingo'){
            showAlert("‚ùå VALSE BINGO: " + (ev.nick || ''));
          }
        }
      }
    }
  });
}
setInterval(poll, 1500);
poll();
initBinIfNeeded();

/* show alert */
function showAlert(txt){
  var a = document.getElementById('alerts');
  a.innerText = txt; a.style.display='block';
  setTimeout(function(){ a.style.display='none'; }, 3500);
}
</script>
</body>
</html>
